{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLEAR25 â€” Early Warning System</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'dashboard/favicon.svg' %}?v=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="{% static 'dashboard/style.css' %}?v=32">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" media="print" onload="this.media='all'">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            850: '#1f1f23',
                            950: '#09090b',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="sidebar-brand">
                    <img src="{% static 'dashboard/favicon.svg' %}" alt="" class="sidebar-logo">
                </div>
                <div class="sidebar-tabs">
                    <a href="/" class="sidebar-tab sidebar-link">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>Home</span>
                    </a>
                    <button class="sidebar-tab tab-active" data-tab="dashboard">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        <span>Dashboard</span>
                    </button>
                    <button class="sidebar-tab" data-tab="map">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                        <span>Live Map</span>
                    </button>
                    <button class="sidebar-tab" data-tab="research">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <span>Research</span>
                    </button>
                    <button class="sidebar-tab" data-tab="feedback">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span>Feedback</span>
                    </button>
                    <button class="sidebar-tab" data-tab="api">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6"/><path d="M8 6l-6 6 6 6"/></svg>
                        <span>API</span>
                    </button>
                </div>
            </div>
            <div class="sidebar-bottom">
                {% if user.is_authenticated %}
                    <div class="account-dropdown account-dropdown-up">
                        <button class="sidebar-account" id="account-toggle" title="{{ user.get_full_name|default:user.email }}">
                            <span class="account-avatar">{{ user.first_name|slice:":1"|default:user.email|slice:":1"|upper }}</span>
                        </button>
                        <div class="account-menu" id="account-menu">
                            <div class="account-menu-header">
                                <div class="account-menu-name">{{ user.get_full_name|default:user.email|default:user.username }}</div>
                                <div class="account-menu-email">{{ user.email }}</div>
                            </div>
                            <div class="account-menu-divider"></div>
                            <a href="{% url 'settings' %}" class="account-menu-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                Settings
                            </a>
                            <a href="{% url 'logout' %}" class="account-menu-item account-menu-logout">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                Log out
                            </a>
                        </div>
                    </div>
                {% else %}
                    <a href="/accounts/google/login/?process=login" class="sidebar-signin">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Sign In
                    </a>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ============================================================ -->
            <!-- TAB: Dashboard                                                -->
            <!-- ============================================================ -->
        <div id="tab-dashboard" class="tab-content tab-visible">
            <!-- Alert Banner -->
            <!-- City Alert Cards -->
            <div class="city-cards" id="city-cards">
                {% for city in cities %}
                <div class="city-card" id="card-{{ city }}">
                    <div class="city-card-glow"></div>
                    <div class="city-card-content">
                        <div class="city-card-name">{{ city }}</div>
                        <div class="city-card-level">Waiting for data</div>
                        <div class="city-card-detail"></div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Action Bar -->
            <div class="actions">
                <button id="btn-demo" class="action-btn action-ghost" onclick="runDemo()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Run Demo
                </button>
                <div id="station-count" class="station-count"></div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-row" id="stats-row" style="display:none;">
                <div class="stat-card">
                    <div class="stat-label">Worst Predicted</div>
                    <div class="stat-value" id="stat-worst">â€”</div>
                    <div class="stat-unit">Âµg/mÂ³</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Stations Reporting</div>
                    <div class="stat-value" id="stat-reporting">â€”</div>
                    <div class="stat-unit">of <span id="stat-total">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Earliest Warning</div>
                    <div class="stat-value" id="stat-lead">â€”</div>
                    <div class="stat-unit">lead time</div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-card">
                <div class="table-head">
                    <span class="th th-city">City</span>
                    <span class="th th-station">Station</span>
                    <span class="th th-dist">Distance</span>
                    <span class="th th-dir">Dir</span>
                    <span class="th th-tier">Tier</span>
                    <span class="th th-pm">PM2.5</span>
                    <span class="th th-pred">Predicted</span>
                    <span class="th th-level">Level</span>
                    <span class="th th-lead">Lead Time</span>
                </div>
                <div id="table-body" class="table-body">
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“¡</div>
                        <div class="empty-text">Loading live data... or click <strong>Run Demo</strong></div>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="footer">
                <div id="status" class="status">Ready</div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- TAB: Live Map                                                 -->
        <!-- ============================================================ -->
        <div id="tab-map" class="tab-content">
            <div class="map-controls">
                <button class="action-btn action-ghost" onclick="mapRunDemo()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Run Demo
                </button>
                <div id="map-status" class="station-count">Live data updates automatically every 30 minutes</div>
            </div>
            <div id="map-container" class="map-container"></div>
            <div class="map-legend">
                <span class="legend-title">Alert Levels:</span>
                <span class="legend-item"><span class="legend-dot" style="background:#A8D5A0"></span>Low</span>
                <span class="legend-item"><span class="legend-dot" style="background:#D2CC9A"></span>Moderate</span>
                <span class="legend-item"><span class="legend-dot" style="background:#F0BFA0"></span>High</span>
                <span class="legend-item"><span class="legend-dot" style="background:#E8988A"></span>Very High</span>
                <span class="legend-item"><span class="legend-dot" style="background:#E65C50"></span>Extreme</span>
                <span class="legend-title" style="margin-left:8px;">Markers:</span>
                <span class="legend-item"><span class="legend-dot" style="background:#fff;border:2px solid #71717a;"></span>City</span>
                <span class="legend-item"><span class="legend-dot" style="background:transparent;border:2px solid #E65C50;box-shadow:inset 0 0 4px #E65C5044;"></span>City Bubble</span>
                <span class="legend-item"><span class="legend-dot legend-dot-empty"></span>No Data</span>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- TAB: Research                                                 -->
        <!-- ============================================================ -->
        <div id="tab-research" class="tab-content">
            <div class="research">
                <!-- Research nav -->
                <div class="research-nav">
                    <button class="rnav rnav-active" data-section="intro">Overview</button>
                    <button class="rnav" data-section="purpose">Purpose</button>
                    <button class="rnav" data-section="methodology">Methodology</button>
                    <button class="rnav" data-section="results">Results</button>
                    <button class="rnav" data-section="validation">Validation</button>
                    <button class="rnav" data-section="alert">Alert System</button>
                    <button class="rnav" data-section="conclusion">Conclusion</button>
                </div>

                <!-- Overview -->
                <div id="sec-intro" class="research-section research-visible">
                    <div class="research-card">
                        <div class="research-badge">C.L.E.A.R. System</div>
                        <h1 class="research-h1">Before the Sky Turns Orange</h1>
                        <p class="research-subtitle">The C.L.E.A.R. System: Canadian Lead-time Early Air Response</p>
                        <p class="research-period">Providing 6â€“48 Hours of Advance Warning for Wildfire Smoke</p>
                    </div>
                    <div class="research-card">
                        <h2>Project Summary</h2>
                        <p>C.L.E.A.R. is a wildfire PM2.5 early warning system for <strong>Toronto, Edmonton, MontrÃ©al, and Vancouver</strong> that repurposes existing NAPS air quality stations located 100â€“600+ km away to provide <strong>6â€“48+ hours of advance warning</strong> before dangerous smoke arrives.</p>
                        <div class="key-stats">
                            <div class="key-stat">
                                <div class="key-stat-value">36M+</div>
                                <div class="key-stat-label">Hourly Observations</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">218</div>
                                <div class="key-stat-label">Stations Identified</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">4 Cities</div>
                                <div class="key-stat-label">Covered</div>
                            </div>
                        </div>
                        <div class="key-stats" style="margin-top:12px;">
                            <div class="key-stat">
                                <div class="key-stat-value">20 yrs</div>
                                <div class="key-stat-label">Study Period (2003â€“2023)</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">97.9%</div>
                                <div class="key-stat-label">Detection Rate</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">0%</div>
                                <div class="key-stat-label">False Alarm Rate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purpose -->
                <div id="sec-purpose" class="research-section">
                    <div class="research-card">
                        <h2>Research Question</h2>
                        <blockquote class="research-quote">"Can hourly PM2.5 readings at distant monitoring stations predict a city's PM2.5 levels with enough lead time to issue meaningful public health warnings?"</blockquote>
                    </div>
                    <div class="research-card">
                        <h2>Purpose</h2>
                        <p>Develop an early warning system that uses <strong>existing NAPS and U.S. EPA monitoring infrastructure</strong> â€” stations located 100â€“600+ km upstream â€” to detect approaching wildfire smoke plumes and issue colour-coded health alerts <strong>6â€“48 hours in advance</strong>.</p>
                        <p>The system targets four major Canadian cities: Toronto, Edmonton, MontrÃ©al, and Vancouver, covering diverse geographic and smoke exposure patterns.</p>
                    </div>
                </div>

                <!-- Methodology -->
                <div id="sec-methodology" class="research-section">
                    <div class="research-card">
                        <h2>Data Sources</h2>
                        <div class="method-grid">
                            <div class="method-item">
                                <h3>NAPS Network (Canada)</h3>
                                <p><strong>National Air Pollution Surveillance Program</strong></p>
                                <p>Hourly PM2.5 measurements. 84% of stations concentrated in BC, AB, ON, and QC. Dense regional coverage enables upstream smoke detection.</p>
                            </div>
                            <div class="method-item">
                                <h3>U.S. EPA AQS / AirNow</h3>
                                <p><strong>Air Quality System &amp; AirNow</strong></p>
                                <p>Daily PM2.5 data from U.S. border stations (NY, PA, VT, WA, OR). Critical for cities near the U.S. border.</p>
                            </div>
                        </div>
                    </div>
                    <div class="research-card">
                        <h2>Analysis Method</h2>
                        <ul class="method-list">
                            <li><strong>Study period:</strong> 2003â€“2023, wildfire season (Mayâ€“September)</li>
                            <li><strong>Correlation analysis</strong> between each remote station and the target city's PM2.5</li>
                            <li><strong>Regression model:</strong> PM2.5<sub>city</sub> = slope &times; PM2.5<sub>station</sub> + intercept</li>
                            <li><strong>Station selection criteria:</strong> R &ge; 0.30, P &lt; 0.001, N &ge; 100 observations</li>
                            <li><strong>Tier classification:</strong> Tier 1 (&gt;250 km, 12â€“48 hr lead) and Tier 2 (100â€“250 km, 6â€“18 hr lead)</li>
                            <li><strong>AI validation:</strong> Claude, ChatGPT, Gemini, and Julius AI all produced mathematically equivalent regression results; hand-verified</li>
                        </ul>
                    </div>
                </div>

                <!-- Results -->
                <div id="sec-results" class="research-section">
                    <div class="research-card">
                        <h2>Historical Validation â€” Confusion Matrix</h2>
                        <p>The system was validated against all historical smoke events (2003â€“2023):</p>
                        <div class="research-table-wrap">
                            <table class="research-table">
                                <thead>
                                    <tr>
                                        <th>City</th>
                                        <th>True Pos.</th>
                                        <th>False Neg.</th>
                                        <th>True Neg.</th>
                                        <th>False Pos.</th>
                                        <th>Detection</th>
                                        <th>False Alarm</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Vancouver</td><td>14</td><td>0</td><td>10</td><td>0</td>
                                        <td class="highlight-green">100%</td><td class="highlight-green">0%</td><td>Perfect</td>
                                    </tr>
                                    <tr>
                                        <td>Edmonton</td><td>9</td><td>1</td><td>5</td><td>0</td>
                                        <td class="highlight-yellow">90%</td><td class="highlight-green">0%</td><td>1 Failure</td>
                                    </tr>
                                    <tr>
                                        <td>Toronto</td><td>10</td><td>0</td><td>10</td><td>0</td>
                                        <td class="highlight-green">100%</td><td class="highlight-green">0%</td><td>Perfect</td>
                                    </tr>
                                    <tr>
                                        <td>MontrÃ©al</td><td>14</td><td>0</td><td>10</td><td>0</td>
                                        <td class="highlight-green">100%</td><td class="highlight-green">0%</td><td>Perfect</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td><strong>Total</strong></td><td><strong>47</strong></td><td><strong>1</strong></td><td><strong>35</strong></td><td><strong>0</strong></td>
                                        <td class="highlight-green"><strong>97.9%</strong></td><td class="highlight-green"><strong>0%</strong></td><td><strong>83 events</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top:12px;color:#a1a1aa;font-size:13px;">Edmonton's single missed event was due to a NNW monitoring gap â€” smoke arrived from an unmonitored direction.</p>
                    </div>
                    <div class="research-card">
                        <h2>Real-World Example â€” Toronto, June 2023</h2>
                        <p>During the catastrophic Quebec wildfire event:</p>
                        <div class="research-table-wrap">
                            <table class="research-table">
                                <thead>
                                    <tr><th>Date</th><th>Station</th><th>Distance</th><th>PM2.5</th><th>Threshold</th><th>Alert</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>June 3</td><td>Parry Sound</td><td>187 km NNW</td>
                                        <td><strong>196 Âµg/mÂ³</strong></td><td>&gt;139.3</td>
                                        <td><span class="badge" style="background:#E65C50;color:white">EXTREME</span></td>
                                    </tr>
                                    <tr>
                                        <td>June 6</td><td>Cornwall</td><td>387 km ENE</td>
                                        <td><strong>160 Âµg/mÂ³</strong></td><td>&gt;99.3</td>
                                        <td><span class="badge" style="background:#E8988A;color:white">VERY HIGH</span></td>
                                    </tr>
                                    <tr class="total-row">
                                        <td>June 6</td><td>Toronto</td><td>â€”</td>
                                        <td><strong>97 Âµg/mÂ³</strong></td><td>(Actual)</td>
                                        <td><span class="badge" style="background:#F0BFA0;color:black">HIGH</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Validation -->
                <div id="sec-validation" class="research-section">
                    <div class="research-card">
                        <h2>Burn Area Analysis</h2>
                        <p>Analysis of the Canadian National Fire Database shows <strong>statistically significant increases</strong> in national burn area over the study period. The 2023 season burned over <strong>18 million hectares</strong>, more than double any previous year.</p>
                        <div class="key-stats">
                            <div class="key-stat">
                                <div class="key-stat-value">18M+ ha</div>
                                <div class="key-stat-label">2023 Record Burn</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">2003â€“2023</div>
                                <div class="key-stat-label">Analysis Period</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value">Significant</div>
                                <div class="key-stat-label">Upward Trend</div>
                            </div>
                        </div>
                    </div>
                    <div class="research-card">
                        <h2>AI Platform Validation</h2>
                        <p>Regression analyses were independently replicated across <strong>four AI platforms</strong> to ensure mathematical accuracy:</p>
                        <div class="key-stats" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="key-stat">
                                <div class="key-stat-value" style="font-size:16px;">Claude</div>
                                <div class="key-stat-label">Anthropic</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value" style="font-size:16px;">ChatGPT</div>
                                <div class="key-stat-label">OpenAI</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value" style="font-size:16px;">Gemini</div>
                                <div class="key-stat-label">Google</div>
                            </div>
                            <div class="key-stat">
                                <div class="key-stat-value" style="font-size:16px;">Julius AI</div>
                                <div class="key-stat-label">Data Analysis</div>
                            </div>
                        </div>
                        <p>All four platforms produced <strong>mathematically equivalent results</strong>, which were then hand-verified against raw data.</p>
                    </div>
                </div>

                <!-- Alert System -->
                <div id="sec-alert" class="research-section">
                    <div class="research-card">
                        <h2>C.L.E.A.R. Alert Levels</h2>
                        <p>The system uses a five-tier alert scale based on predicted PM2.5 concentrations:</p>
                        <div class="research-table-wrap">
                            <table class="research-table alert-table">
                                <thead>
                                    <tr><th>Alert Level</th><th>PM2.5 Level</th><th>Public Health Action Plan</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="badge" style="background:#A8D5A0;color:black;font-size:12px;padding:5px 14px;">LOW</span></td>
                                        <td>&lt; 20 Âµg/mÂ³</td>
                                        <td>No precautions needed.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge" style="background:#D2CC9A;color:black;font-size:12px;padding:5px 14px;">MODERATE</span></td>
                                        <td>21â€“60 Âµg/mÂ³</td>
                                        <td>Sensitive groups (children/elderly) avoid strenuous activities.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge" style="background:#F0BFA0;color:black;font-size:12px;padding:5px 14px;">HIGH</span></td>
                                        <td>61â€“80 Âµg/mÂ³</td>
                                        <td>Everyone should reduce physical exertion. N95 or KN95 mask. Keep doors and windows closed. HVAC to recirculate. Run HEPA filter.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge" style="background:#E8988A;color:white;font-size:12px;padding:5px 14px;">VERY HIGH</span></td>
                                        <td>81â€“120 Âµg/mÂ³</td>
                                        <td>Avoid all outdoor activity. Keep hydrated.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge" style="background:#E65C50;color:white;font-size:12px;padding:5px 14px;">EXTREME</span></td>
                                        <td>&gt; 120 Âµg/mÂ³</td>
                                        <td>Halt indoor pollution. No frying or sauteing. No vacuuming. No candles. No wood-burning stoves.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="research-card">
                        <h2>How It Works</h2>
                        <p>For each included station, the system uses a simple linear regression:</p>
                        <div class="equation">PM2.5<sub>city</sub> = slope &times; PM2.5<sub>station</sub> + intercept</div>
                        <p>Alert thresholds at each station are computed by inverting the formula:</p>
                        <div class="equation">station threshold = (alert trigger &minus; intercept) &divide; slope</div>
                        <p>When a station's live PM2.5 reading exceeds its computed threshold, the corresponding alert is triggered â€” providing advance warning based on the station's distance and tier classification.</p>
                    </div>
                </div>

                <!-- Conclusion -->
                <div id="sec-conclusion" class="research-section">
                    <div class="research-card">
                        <h2>Conclusion</h2>
                        <div class="conclusion-grid">
                            <div class="conclusion-item">
                                <h3>Novel Contribution</h3>
                                <p>First system to repurpose existing NAPS infrastructure specifically for wildfire smoke early warning across multiple Canadian cities.</p>
                            </div>
                            <div class="conclusion-item">
                                <h3>Proven Reliability</h3>
                                <p>97.9% detection rate (47/48 events) with 0% false alarms (35/35 non-events) across all four cities.</p>
                            </div>
                            <div class="conclusion-item">
                                <h3>Actionable Results</h3>
                                <p>Colour-coded alerts with specific health recommendations give the public clear guidance hours before smoke arrives.</p>
                            </div>
                            <div class="conclusion-item">
                                <h3>Scalable Solution</h3>
                                <p>The methodology can be extended to any city with nearby upstream monitoring stations.</p>
                            </div>
                        </div>
                    </div>
                    <div class="research-card">
                        <h2>Future Work</h2>
                        <ul class="method-list">
                            <li><strong>Satellite integration</strong> for real-time smoke plume tracking</li>
                            <li><strong>More cities</strong> added to the network</li>
                            <li><strong>Live testing</strong> during upcoming wildfire seasons</li>
                            <li><strong>Expanded NAPS coverage</strong> to address monitoring gaps (e.g., Edmonton NNW)</li>
                            <li><strong>Wind direction/speed</strong> incorporation for improved predictions</li>
                        </ul>
                    </div>
                    <div class="research-card">
                        <h2>References</h2>
                        <ul class="method-list ref-list">
                            <li>Anthropic (2026). Claude AI Platform.</li>
                            <li>Cruz, M. G. et al. (2019). Fire dynamics and behaviour.</li>
                            <li>Environment and Climate Change Canada. National Air Pollution Surveillance (NAPS) Program.</li>
                            <li>U.S. Environmental Protection Agency. Air Quality System (AQS) &amp; AirNow.</li>
                            <li>IQAir / World Health Organization. PM2.5 health guidelines.</li>
                            <li>National Forestry Database. Canadian wildfire statistics.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- TAB: Feedback                                                 -->
        <!-- ============================================================ -->
        <div id="tab-feedback" class="tab-content">
            <div class="feedback-board">
                <!-- Header -->
                <div class="feedback-header">
                    <div class="feedback-header-left">
                        <h2>Improvement Board</h2>
                        <p>Share ideas, report bugs, and vote on suggestions from the community.</p>
                    </div>
                    <button id="btn-new-suggestion" class="action-btn action-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        New Suggestion
                    </button>
                </div>

                <!-- Sort tabs -->
                <div class="feedback-sort">
                    <button class="sort-btn sort-active" data-sort="hot">Hot</button>
                    <button class="sort-btn" data-sort="new">New</button>
                    <button class="sort-btn" data-sort="top">Top</button>
                </div>

                <!-- Suggestions list -->
                <div id="suggestions-list" class="suggestions-list">
                    <div class="suggestions-empty">Loading suggestions...</div>
                </div>

                <!-- New suggestion modal -->
                <div id="modal-suggestion" class="modal-overlay" style="display:none;">
                    <div class="modal-box">
                        <div class="modal-header">
                            <h3>New Suggestion</h3>
                            <button class="modal-close" id="modal-suggestion-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="suggestion-title">Title</label>
                                <input type="text" id="suggestion-title" placeholder="Brief summary of your idea..." maxlength="200">
                            </div>
                            <div class="form-group">
                                <label for="suggestion-body">Description</label>
                                <textarea id="suggestion-body" rows="5" placeholder="Describe your suggestion in detail..."></textarea>
                            </div>
                            <div id="suggestion-error" class="form-error" style="display:none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="action-btn action-secondary" id="modal-suggestion-cancel">Cancel</button>
                            <button class="action-btn action-primary" id="modal-suggestion-submit">Submit</button>
                        </div>
                    </div>
                </div>

                <!-- Suggestion detail modal -->
                <div id="modal-detail" class="modal-overlay" style="display:none;">
                    <div class="modal-box modal-box-lg">
                        <div class="modal-header">
                            <h3 id="detail-title" class="flex-1 pr-4">Suggestion</h3>
                            <button id="btn-delete-suggestion" class="text-zinc-500 hover:text-red-500 mr-3 hidden" title="Delete suggestion">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                            </button>
                            <button class="modal-close" id="modal-detail-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-meta mb-4">
                                <img src="" alt="" id="detail-avatar" class="detail-avatar">
                                <span id="detail-author"></span>
                                <span id="detail-date"></span>
                            </div>
                            <div id="detail-body" class="detail-body mb-5"></div>
                            <div class="detail-votes mb-6">
                                <button class="vote-btn vote-up" id="detail-upvote">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
                                </button>
                                <span id="detail-score">0</span>
                                <button class="vote-btn vote-down" id="detail-downvote">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                            </div>
                            <hr class="detail-divider">
                            <h4 class="text-base font-semibold text-zinc-100 mb-4 mt-5">Comments</h4>
                            <div id="detail-comments" class="detail-comments mb-5"></div>
                            <div class="comment-form mt-4">
                                <textarea id="comment-input" rows="2" placeholder="Add a comment..." class="flex-1"></textarea>
                                <button class="action-btn action-primary" id="btn-add-comment">Comment</button>
                            </div>
                            <div id="comment-error" class="form-error mt-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Login prompt modal -->
                <div id="modal-login" class="modal-overlay" style="display:none;">
                    <div class="modal-box modal-box-sm">
                        <div class="modal-header">
                            <h3>Sign in required</h3>
                            <button class="modal-close" id="modal-login-close">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align:center;padding:24px;">
                            <p style="margin-bottom:16px;">Sign in with Google to post suggestions, vote, and comment.</p>
                            <a href="/accounts/google/login/" class="action-btn action-primary" style="text-decoration:none;display:inline-flex;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Sign in with Google
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- ============================================================ -->
            <!-- TAB: API                                                      -->
            <!-- ============================================================ -->
            <div id="tab-api" class="tab-content">
                <div class="api-docs">
                    <div class="research-badge">Developer API</div>
                    <h1 class="research-h1">CLEAR25 API</h1>
                    <p class="research-intro" style="margin-bottom:32px;">
                        Access real-time PM2.5 readings and predictions programmatically. Build integrations, dashboards, or custom alerts.
                    </p>

                    <!-- API Keys Section -->
                    <div class="research-card" style="margin-bottom:24px;">
                        <h2 class="research-subtitle" style="margin-bottom:16px;">Your API Keys</h2>
                        {% if user.is_authenticated %}
                            <div id="api-keys-list">
                                <div class="api-keys-empty" id="api-keys-empty" style="text-align:center;padding:24px;color:#71717a;">
                                    Loading...
                                </div>
                            </div>
                            <button class="action-btn action-primary" id="btn-create-api-key" style="margin-top:16px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                Create API Key
                            </button>
                        {% else %}
                            <div style="text-align:center;padding:24px;">
                                <p style="color:#71717a;margin-bottom:16px;">Sign in to create and manage your API keys.</p>
                                <a href="/accounts/google/login/" class="action-btn action-primary" style="text-decoration:none;display:inline-flex;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    Sign in with Google
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Quick Start -->
                    <div class="research-card" style="margin-bottom:24px;">
                        <h2 class="research-subtitle">Quick Start</h2>
                        <p>Base URL: <code>https://clear25.xyz/api/v1/</code></p>
                        <p style="margin-top:12px;">All requests require an API key in the Authorization header:</p>
                        <pre>Authorization: Bearer YOUR_API_KEY</pre>
                    </div>

                    <!-- Level Reference -->
                    <div class="research-card" style="margin-bottom:24px;">
                        <h2 class="research-subtitle">Air Quality Levels</h2>
                        <p style="margin-bottom:16px;">The API returns air quality as an integer <code>level</code> (1-5):</p>
                        <table class="research-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th style="width:60px;">Level</th>
                                    <th style="width:100px;">Name</th>
                                    <th style="width:120px;">PM2.5 Range</th>
                                    <th>Health Advisory</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span style="display:inline-block;padding:4px 10px;border-radius:4px;background:#A8D5A0;color:#000;font-weight:600;font-size:12px;">1</span></td>
                                    <td>NONE</td>
                                    <td>0 - 31 Âµg/mÂ³</td>
                                    <td style="color:#71717a;">No precautions needed.</td>
                                </tr>
                                <tr>
                                    <td><span style="display:inline-block;padding:4px 10px;border-radius:4px;background:#D2CC9A;color:#000;font-weight:600;font-size:12px;">2</span></td>
                                    <td>MODERATE</td>
                                    <td>31 - 60 Âµg/mÂ³</td>
                                    <td style="color:#71717a;">Sensitive groups avoid strenuous activities.</td>
                                </tr>
                                <tr>
                                    <td><span style="display:inline-block;padding:4px 10px;border-radius:4px;background:#F0BFA0;color:#000;font-weight:600;font-size:12px;">3</span></td>
                                    <td>HIGH</td>
                                    <td>60 - 80 Âµg/mÂ³</td>
                                    <td style="color:#71717a;">Everyone reduce physical exertion. Use N95 mask.</td>
                                </tr>
                                <tr>
                                    <td><span style="display:inline-block;padding:4px 10px;border-radius:4px;background:#E8988A;color:#fff;font-weight:600;font-size:12px;">4</span></td>
                                    <td>VERY HIGH</td>
                                    <td>80 - 120 Âµg/mÂ³</td>
                                    <td style="color:#71717a;">Avoid all outdoor activity. Keep hydrated.</td>
                                </tr>
                                <tr>
                                    <td><span style="display:inline-block;padding:4px 10px;border-radius:4px;background:#E65C50;color:#fff;font-weight:600;font-size:12px;">5</span></td>
                                    <td>EXTREME</td>
                                    <td>&gt;120 Âµg/mÂ³</td>
                                    <td style="color:#71717a;">Halt all indoor pollution sources.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Endpoints -->
                    <div class="research-card" style="margin-bottom:24px;">
                        <h2 class="research-subtitle">Endpoints</h2>

                        <!-- GET /api/v1/live -->
                        <div class="endpoint-card">
                            <div class="endpoint-header">
                                <span class="endpoint-method">GET</span>
                                <code class="endpoint-path">/api/v1/live/</code>
                            </div>
                            <div class="endpoint-body">
                                <p style="color:#a1a1aa;margin-bottom:12px;">Get current PM2.5 readings and 1-hour predictions for all stations.</p>
                                <div class="response-label">Response</div>
                                <pre>{
  "stations": [
    {
      "id": "60106",
      "name": "Station Name",
      "city": "Toronto",
      "lat": 43.6591,
      "lon": -79.3802,
      "pm25": 45.2,
      "predicted": 52.1,
      "level": 2,
      "level_name": "MODERATE",
      "health_advisory": "..."
    }
  ],
  "count": 50,
  "timestamp": "2025-02-07T10:30:00Z",
  "age_seconds": 120
}</pre>
                            </div>
                        </div>

                        <!-- GET /api/v1/stations -->
                        <div class="endpoint-card">
                            <div class="endpoint-header">
                                <span class="endpoint-method">GET</span>
                                <code class="endpoint-path">/api/v1/stations/</code>
                            </div>
                            <div class="endpoint-body">
                                <p style="color:#a1a1aa;">Get list of all monitoring stations. Optional <code>?city=Toronto</code> filter.</p>
                            </div>
                        </div>

                        <!-- GET /api/v1/cities -->
                        <div class="endpoint-card" style="margin-bottom:0;">
                            <div class="endpoint-header">
                                <span class="endpoint-method">GET</span>
                                <code class="endpoint-path">/api/v1/cities/</code>
                            </div>
                            <div class="endpoint-body">
                                <p style="color:#a1a1aa;">Get list of supported cities with coordinates.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Rate Limits -->
                    <div class="research-card">
                        <h2 class="research-subtitle">Rate Limits & Errors</h2>
                        <ul class="method-list">
                            <li><strong>100 requests per hour</strong> â€” limit applies per API key, not per user</li>
                            <li>Data refreshes every 30 minutes</li>
                            <li><code>401</code> â€” Missing or invalid API key</li>
                            <li><code>429</code> â€” Rate limit exceeded (check <code>X-RateLimit-Reset</code> header)</li>
                        </ul>
                        <p style="margin-top:12px;color:#71717a;font-size:13px;">Rate limit headers are included in all API responses: <code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, <code>X-RateLimit-Reset</code></p>
                    </div>
                </div>

                <!-- Create API Key Modal -->
                <div id="modal-create-key" class="modal-overlay" style="display:none;">
                    <div class="modal-box modal-box-sm">
                        <div class="modal-header">
                            <h3>Create API Key</h3>
                            <button class="modal-close" id="modal-create-key-close">&times;</button>
                        </div>
                        <div class="modal-body" style="padding:20px;">
                            <label style="display:block;font-size:13px;color:#a1a1aa;margin-bottom:8px;">Key Name (optional)</label>
                            <input type="text" id="api-key-name" placeholder="e.g., Production App, Testing" style="width:100%;padding:10px 12px;background:#18181b;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:14px;">
                            <p style="font-size:12px;color:#71717a;margin-top:8px;">Give your key a name to help identify it later.</p>
                            <div id="create-key-error" class="form-error mt-3" style="display:none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="action-btn action-secondary" id="modal-create-key-cancel">Cancel</button>
                            <button class="action-btn action-primary" id="modal-create-key-submit">Create Key</button>
                        </div>
                    </div>
                </div>

                <!-- New API Key Display Modal -->
                <div id="modal-new-key" class="modal-overlay" style="display:none;">
                    <div class="modal-box modal-box-sm">
                        <div class="modal-header">
                            <h3>API Key Created</h3>
                        </div>
                        <div class="modal-body" style="padding:20px;text-align:center;">
                            <div style="width:48px;height:48px;background:#22c55e20;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                            <p style="color:#a1a1aa;margin-bottom:16px;">Your new API key has been created. Copy it now â€” you won't be able to see it again!</p>
                            <div style="background:#000;border:1px solid #27272a;border-radius:8px;padding:12px;margin-bottom:16px;">
                                <code id="new-key-display" style="font-family:'JetBrains Mono',monospace;font-size:12px;color:#22c55e;word-break:break-all;"></code>
                            </div>
                            <button class="action-btn action-primary" id="copy-new-key" style="width:100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                        <div class="modal-footer">
                            <button class="action-btn action-secondary" id="modal-new-key-done" style="width:100%;">Done</button>
                        </div>
                    </div>
                </div>

                <!-- Toast notification container -->
                <div id="toast-container" style="position:fixed;bottom:24px;right:24px;z-index:10000;"></div>
            </div>

        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{% static 'dashboard/app.js' %}?v=21"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
